# Expose all (except xen-frontend) block devices via Qubes DB

# Only block devices are interesting
SUBSYSTEM!="block", GOTO="qubes_block_end"

# Hide qubes-internal drives from udisks, so file selection dialogs
ENV{MAJOR}=="7", ENV{UDISKS_IGNORE}="1"
KERNEL=="xvda|xvdb|xvdc*|xvdd", ENV{UDISKS_IGNORE}="1"

# Skip xen-blkfront devices
ENV{MAJOR}=="202", GOTO="qubes_block_end"

# skip devices excluded elsewhere
ENV{DM_UDEV_DISABLE_DISK_RULES_FLAG}=="1", GOTO="qubes_block_end"

# Skip device-mapper devices
KERNEL=="dm-*", ENV{DM_NAME}=="snapshot-*", GOTO="qubes_block_end"
KERNEL=="dm-*", ENV{DM_NAME}=="origin-*", GOTO="qubes_block_end"
KERNEL=="dm-*", ENV{DM_NAME}=="", GOTO="qubes_block_end"

# generate cropped uuid and populate qname variable
ACTION=="add", ENV{ID_SERIAL}=="?*", PROGRAM="/bin/sh -c '/usr/bin/uuidgen -s -n @oid -N $env{ID_SERIAL}$env{PARTN}|cut -d- -f5'", ENV{QNAME}="$result"

# check if device already exist in qubesdb
ACTION=="add", ENV{QNAME}=="?*", PROGRAM="/bin/sh -c '/usr/bin/qubesdb-read -q /qubes-block-devices/$env{QNAME}/desc || echo 1'", RESULT=="1", GOTO="skip_qname_fallback"

# fallback for duplicates
ACTION=="add", PROGRAM="/usr/bin/basename $env{DEVNAME}", ENV{QNAME}="$result"

LABEL="skip_qname_fallback"

IMPORT{db}="QNAME"

ACTION=="add", RUN+="/usr/lib/qubes/udev-block-add-change"
ACTION=="change", RUN+="/usr/lib/qubes/udev-block-add-change"
ACTION=="remove", RUN+="/usr/lib/qubes/udev-block-remove"

LABEL="qubes_block_end"
